<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gradio API æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .video-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        video,
        canvas {
            width: 100%;
            background: #000;
            border-radius: 5px;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
        }

        button:hover {
            background: #45a049;
        }

        .stop {
            background: #f44336;
        }

        .stop:hover {
            background: #da190b;
        }

        #log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .stat {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ”¦ Gradio æ‘„åƒå¤´æ£€æµ‹æµ‹è¯•</h1>

        <div>
            <label>æœåŠ¡å™¨åœ°å€: </label>
            <input type="text" id="serverUrl" value="http://localhost:7860" style="width: 300px; padding: 8px;">
        </div>

        <div style="margin: 20px 0;">
            <button onclick="startWebcam()">ğŸ“¹ å¯åŠ¨æ‘„åƒå¤´</button>
            <button onclick="captureAndDetect()" id="detectBtn" disabled>ğŸ” å•æ¬¡æ£€æµ‹</button>
            <button onclick="startContinuous()" id="contBtn" disabled>â–¶ï¸ è¿ç»­æ£€æµ‹</button>
            <button onclick="stopContinuous()" class="stop" id="stopBtn" disabled>â¹ï¸ åœæ­¢</button>
        </div>

        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="detectionCount">0</div>
                <div class="stat-label">æ£€æµ‹æ•°é‡</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="totalFrames">0</div>
                <div class="stat-label">æ€»å¸§æ•°</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="latency">0ms</div>
                <div class="stat-label">å»¶è¿Ÿ</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="status">å¾…æœº</div>
                <div class="stat-label">çŠ¶æ€</div>
            </div>
        </div>

        <div class="video-grid">
            <div>
                <h3>æœ¬åœ°æ‘„åƒå¤´</h3>
                <video id="video" autoplay playsinline></video>
            </div>
            <div>
                <h3>æ£€æµ‹ç»“æœ</h3>
                <canvas id="canvas"></canvas>
            </div>
        </div>

        <div id="log"></div>
    </div>

    <script>
        let video, canvas, ctx;
        let isRunning = false;
        let continuousInterval = null;
        let totalFrames = 0;

        function log(msg) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${msg}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(msg);
        }

        async function startWebcam() {
            try {
                log('ğŸ¥ è¯·æ±‚æ‘„åƒå¤´æƒé™...');
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 1280, height: 720 }
                });

                video = document.getElementById('video');
                canvas = document.getElementById('canvas');
                ctx = canvas.getContext('2d');

                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    log(`âœ… æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ (${video.videoWidth}x${video.videoHeight})`);

                    document.getElementById('detectBtn').disabled = false;
                    document.getElementById('contBtn').disabled = false;
                };
            } catch (error) {
                log(`âŒ æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: ${error.message}`);
            }
        }

        async function captureAndDetect() {
            const startTime = Date.now();
            totalFrames++;
            document.getElementById('totalFrames').textContent = totalFrames;
            document.getElementById('status').textContent = 'æ£€æµ‹ä¸­...';

            try {
                // ç»˜åˆ¶å½“å‰å¸§
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // è½¬æ¢ä¸ºBlob
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
                log(`ğŸ“¸ æ•è·å¸§ #${totalFrames} (${(blob.size / 1024).toFixed(1)}KB)`);

                const serverUrl = document.getElementById('serverUrl').value;

                // æ–¹æ³•1: å°è¯•ç›´æ¥è°ƒç”¨å›¾åƒæ£€æµ‹API
                log(`ğŸ”„ ä¸Šä¼ å›¾ç‰‡åˆ°æœåŠ¡å™¨...`);
                const formData = new FormData();
                formData.append('files', blob, 'webcam.jpg');

                const uploadResponse = await fetch(`${serverUrl}/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!uploadResponse.ok) {
                    throw new Error(`ä¸Šä¼ å¤±è´¥: ${uploadResponse.status}`);
                }

                const uploadResult = await uploadResponse.json();
                log(`âœ… ä¸Šä¼ æˆåŠŸ: ${JSON.stringify(uploadResult)}`);

                // è°ƒç”¨å¤„ç†å‡½æ•°
                log(`ğŸ” è°ƒç”¨æ£€æµ‹API...`);
                const detectResponse = await fetch(`${serverUrl}/call/process_webcam_frame`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        data: [
                            uploadResult[0],  // æ–‡ä»¶è·¯å¾„
                            0.15,             // confidence
                            false             // show_depth
                        ]
                    })
                });

                if (!detectResponse.ok) {
                    throw new Error(`æ£€æµ‹è¯·æ±‚å¤±è´¥: ${detectResponse.status}`);
                }

                const detectResult = await detectResponse.json();
                log(`ğŸ“¦ æ”¶åˆ°å“åº”: ${JSON.stringify(detectResult).substring(0, 200)}...`);

                if (detectResult.event_id) {
                    // è½®è¯¢ç»“æœ
                    log(`â³ ç­‰å¾…ç»“æœ (event_id: ${detectResult.event_id})...`);
                    let attempts = 0;
                    const maxAttempts = 30;

                    while (attempts < maxAttempts) {
                        await new Promise(resolve => setTimeout(resolve, 500));

                        const statusResponse = await fetch(`${serverUrl}/call/process_webcam_frame/${detectResult.event_id}`);
                        const statusResult = await statusResponse.json();

                        log(`ğŸ“Š çŠ¶æ€æ£€æŸ¥ #${attempts + 1}: ${statusResult.status || 'unknown'}`);

                        if (statusResult.status === 'COMPLETE' || statusResult.output) {
                            log(`âœ… æ£€æµ‹å®Œæˆ!`);

                            // æ˜¾ç¤ºç»“æœ
                            if (statusResult.output && statusResult.output.data) {
                                const [resultImgData, depthImgData, statsText] = statusResult.output.data;

                                if (resultImgData && resultImgData.url) {
                                    const img = new Image();
                                    img.onload = () => {
                                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                        log(`ğŸ–¼ï¸ ç»“æœå›¾åƒå·²æ˜¾ç¤º`);
                                    };
                                    img.src = `${serverUrl}/file=${resultImgData.url}`;
                                }

                                if (statsText) {
                                    const match = statsText.match(/æ£€æµ‹æ•°é‡\*\*:\s*(\d+)/);
                                    if (match) {
                                        document.getElementById('detectionCount').textContent = match[1];
                                        log(`ğŸ¯ æ£€æµ‹åˆ° ${match[1]} ä¸ªç›®æ ‡`);
                                    }
                                }
                            }
                            break;
                        }

                        attempts++;
                    }

                    if (attempts >= maxAttempts) {
                        log(`âš ï¸ è¶…æ—¶: ç­‰å¾…ç»“æœè¶…è¿‡ ${maxAttempts * 0.5}ç§’`);
                    }
                }

                const latency = Date.now() - startTime;
                document.getElementById('latency').textContent = `${latency}ms`;
                document.getElementById('status').textContent = 'å®Œæˆ';
                log(`â±ï¸ æ€»è€—æ—¶: ${latency}ms`);

            } catch (error) {
                log(`âŒ é”™è¯¯: ${error.message}`);
                document.getElementById('status').textContent = 'é”™è¯¯';
                ctx.fillStyle = 'red';
                ctx.font = '20px Arial';
                ctx.fillText('âŒ ' + error.message, 10, 30);
            }
        }

        function startContinuous() {
            if (continuousInterval) return;

            log('â–¶ï¸ å¼€å§‹è¿ç»­æ£€æµ‹...');
            document.getElementById('contBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            isRunning = true;

            continuousInterval = setInterval(() => {
                if (isRunning) {
                    captureAndDetect();
                }
            }, 3000); // æ¯3ç§’æ£€æµ‹ä¸€æ¬¡
        }

        function stopContinuous() {
            log('â¹ï¸ åœæ­¢è¿ç»­æ£€æµ‹');
            isRunning = false;
            if (continuousInterval) {
                clearInterval(continuousInterval);
                continuousInterval = null;
            }
            document.getElementById('contBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('status').textContent = 'å·²åœæ­¢';
        }
    </script>
</body>

</html>