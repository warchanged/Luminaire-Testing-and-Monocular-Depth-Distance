<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gradio API 测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .video-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        video,
        canvas {
            width: 100%;
            background: #000;
            border-radius: 5px;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
        }

        button:hover {
            background: #45a049;
        }

        .stop {
            background: #f44336;
        }

        .stop:hover {
            background: #da190b;
        }

        #log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .stat {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>🔦 Gradio 摄像头检测测试</h1>

        <div>
            <label>服务器地址: </label>
            <input type="text" id="serverUrl" value="http://localhost:7860" style="width: 300px; padding: 8px;">
        </div>

        <div style="margin: 20px 0;">
            <button onclick="startWebcam()">📹 启动摄像头</button>
            <button onclick="captureAndDetect()" id="detectBtn" disabled>🔍 单次检测</button>
            <button onclick="startContinuous()" id="contBtn" disabled>▶️ 连续检测</button>
            <button onclick="stopContinuous()" class="stop" id="stopBtn" disabled>⏹️ 停止</button>
        </div>

        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="detectionCount">0</div>
                <div class="stat-label">检测数量</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="totalFrames">0</div>
                <div class="stat-label">总帧数</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="latency">0ms</div>
                <div class="stat-label">延迟</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="status">待机</div>
                <div class="stat-label">状态</div>
            </div>
        </div>

        <div class="video-grid">
            <div>
                <h3>本地摄像头</h3>
                <video id="video" autoplay playsinline></video>
            </div>
            <div>
                <h3>检测结果</h3>
                <canvas id="canvas"></canvas>
            </div>
        </div>

        <div id="log"></div>
    </div>

    <script>
        let video, canvas, ctx;
        let isRunning = false;
        let continuousInterval = null;
        let totalFrames = 0;

        function log(msg) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${msg}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(msg);
        }

        async function startWebcam() {
            try {
                log('🎥 请求摄像头权限...');
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 1280, height: 720 }
                });

                video = document.getElementById('video');
                canvas = document.getElementById('canvas');
                ctx = canvas.getContext('2d');

                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    log(`✅ 摄像头启动成功 (${video.videoWidth}x${video.videoHeight})`);

                    document.getElementById('detectBtn').disabled = false;
                    document.getElementById('contBtn').disabled = false;
                };
            } catch (error) {
                log(`❌ 摄像头启动失败: ${error.message}`);
            }
        }

        async function captureAndDetect() {
            const startTime = Date.now();
            totalFrames++;
            document.getElementById('totalFrames').textContent = totalFrames;
            document.getElementById('status').textContent = '检测中...';

            try {
                // 绘制当前帧
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // 转换为Blob
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
                log(`📸 捕获帧 #${totalFrames} (${(blob.size / 1024).toFixed(1)}KB)`);

                const serverUrl = document.getElementById('serverUrl').value;

                // 方法1: 尝试直接调用图像检测API
                log(`🔄 上传图片到服务器...`);
                const formData = new FormData();
                formData.append('files', blob, 'webcam.jpg');

                const uploadResponse = await fetch(`${serverUrl}/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!uploadResponse.ok) {
                    throw new Error(`上传失败: ${uploadResponse.status}`);
                }

                const uploadResult = await uploadResponse.json();
                log(`✅ 上传成功: ${JSON.stringify(uploadResult)}`);

                // 调用处理函数
                log(`🔍 调用检测API...`);
                const detectResponse = await fetch(`${serverUrl}/call/process_webcam_frame`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        data: [
                            uploadResult[0],  // 文件路径
                            0.15,             // confidence
                            false             // show_depth
                        ]
                    })
                });

                if (!detectResponse.ok) {
                    throw new Error(`检测请求失败: ${detectResponse.status}`);
                }

                const detectResult = await detectResponse.json();
                log(`📦 收到响应: ${JSON.stringify(detectResult).substring(0, 200)}...`);

                if (detectResult.event_id) {
                    // 轮询结果
                    log(`⏳ 等待结果 (event_id: ${detectResult.event_id})...`);
                    let attempts = 0;
                    const maxAttempts = 30;

                    while (attempts < maxAttempts) {
                        await new Promise(resolve => setTimeout(resolve, 500));

                        const statusResponse = await fetch(`${serverUrl}/call/process_webcam_frame/${detectResult.event_id}`);
                        const statusResult = await statusResponse.json();

                        log(`📊 状态检查 #${attempts + 1}: ${statusResult.status || 'unknown'}`);

                        if (statusResult.status === 'COMPLETE' || statusResult.output) {
                            log(`✅ 检测完成!`);

                            // 显示结果
                            if (statusResult.output && statusResult.output.data) {
                                const [resultImgData, depthImgData, statsText] = statusResult.output.data;

                                if (resultImgData && resultImgData.url) {
                                    const img = new Image();
                                    img.onload = () => {
                                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                        log(`🖼️ 结果图像已显示`);
                                    };
                                    img.src = `${serverUrl}/file=${resultImgData.url}`;
                                }

                                if (statsText) {
                                    const match = statsText.match(/检测数量\*\*:\s*(\d+)/);
                                    if (match) {
                                        document.getElementById('detectionCount').textContent = match[1];
                                        log(`🎯 检测到 ${match[1]} 个目标`);
                                    }
                                }
                            }
                            break;
                        }

                        attempts++;
                    }

                    if (attempts >= maxAttempts) {
                        log(`⚠️ 超时: 等待结果超过 ${maxAttempts * 0.5}秒`);
                    }
                }

                const latency = Date.now() - startTime;
                document.getElementById('latency').textContent = `${latency}ms`;
                document.getElementById('status').textContent = '完成';
                log(`⏱️ 总耗时: ${latency}ms`);

            } catch (error) {
                log(`❌ 错误: ${error.message}`);
                document.getElementById('status').textContent = '错误';
                ctx.fillStyle = 'red';
                ctx.font = '20px Arial';
                ctx.fillText('❌ ' + error.message, 10, 30);
            }
        }

        function startContinuous() {
            if (continuousInterval) return;

            log('▶️ 开始连续检测...');
            document.getElementById('contBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            isRunning = true;

            continuousInterval = setInterval(() => {
                if (isRunning) {
                    captureAndDetect();
                }
            }, 3000); // 每3秒检测一次
        }

        function stopContinuous() {
            log('⏹️ 停止连续检测');
            isRunning = false;
            if (continuousInterval) {
                clearInterval(continuousInterval);
                continuousInterval = null;
            }
            document.getElementById('contBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('status').textContent = '已停止';
        }
    </script>
</body>

</html>