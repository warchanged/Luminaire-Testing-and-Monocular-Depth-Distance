<!DOCTYPE html>
<html>

<head>
    <title>Gradio 连接测试</title>
    <style>
        body {
            font-family: Arial;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }

        .test {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
        }

        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 5px;
            cursor: pointer;
        }

        pre {
            background: #f5f5f5;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>🔍 Gradio 服务器连接测试</h1>

    <div>
        <label>服务器地址: </label>
        <input type="text" id="serverUrl" value="http://localhost:7860" style="width: 300px; padding: 8px;">
        <button onclick="runAllTests()">🧪 运行所有测试</button>
    </div>

    <div id="results"></div>

    <script>
        async function addResult(title, content, isError = false) {
            const div = document.createElement('div');
            div.className = `test ${isError ? 'error' : 'success'}`;
            div.innerHTML = `<h3>${title}</h3><pre>${content}</pre>`;
            document.getElementById('results').appendChild(div);
        }

        async function addInfo(title, content) {
            const div = document.createElement('div');
            div.className = 'test info';
            div.innerHTML = `<h3>${title}</h3><pre>${content}</pre>`;
            document.getElementById('results').appendChild(div);
        }

        async function runAllTests() {
            document.getElementById('results').innerHTML = '';
            const serverUrl = document.getElementById('serverUrl').value;

            // 测试1: 基本连接
            addInfo('测试 1', '检查服务器是否可访问...');
            try {
                const response = await fetch(serverUrl, { method: 'GET' });
                addResult('✅ 测试 1: 基本连接',
                    `状态码: ${response.status}\n内容类型: ${response.headers.get('content-type')}`);
            } catch (error) {
                addResult('❌ 测试 1: 基本连接失败', error.message, true);
                return; // 如果基本连接失败,停止其他测试
            }

            // 测试2: 获取 Gradio 配置
            addInfo('测试 2', '获取 Gradio API 配置...');
            try {
                const response = await fetch(`${serverUrl}/config`, { method: 'GET' });
                const data = await response.json();
                addResult('✅ 测试 2: API 配置', JSON.stringify(data, null, 2).substring(0, 500) + '...');
            } catch (error) {
                addResult('❌ 测试 2: API 配置获取失败', error.message, true);
            }

            // 测试3: 检查上传端点
            addInfo('测试 3', '测试文件上传端点...');
            try {
                const blob = new Blob(['test'], { type: 'text/plain' });
                const formData = new FormData();
                formData.append('files', blob, 'test.txt');

                const response = await fetch(`${serverUrl}/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    addResult('✅ 测试 3: 文件上传', JSON.stringify(data, null, 2));
                } else {
                    addResult('❌ 测试 3: 上传失败', `状态码: ${response.status}`, true);
                }
            } catch (error) {
                addResult('❌ 测试 3: 上传端点错误', error.message, true);
            }

            // 测试4: 检查可用的 API 函数
            addInfo('测试 4', '检查可用的 API 函数...');
            try {
                const response = await fetch(`${serverUrl}/config`, { method: 'GET' });
                const data = await response.json();

                if (data.dependencies) {
                    const functionNames = data.dependencies.map(d => d.targets ? d.targets.map(t => t[1]) : []).flat();
                    addResult('✅ 测试 4: 可用函数',
                        `发现 ${functionNames.length} 个函数:\n${functionNames.join('\n')}`);
                } else {
                    addResult('⚠️ 测试 4: 未找到函数列表', '配置中没有 dependencies 字段', true);
                }
            } catch (error) {
                addResult('❌ 测试 4: 函数检查失败', error.message, true);
            }

            // 测试5: CORS 测试
            addInfo('测试 5', '测试 CORS 设置...');
            try {
                const response = await fetch(`${serverUrl}/config`, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST'
                    }
                });

                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
                };

                addResult('✅ 测试 5: CORS 设置', JSON.stringify(corsHeaders, null, 2));
            } catch (error) {
                addResult('❌ 测试 5: CORS 测试失败', error.message, true);
            }
        }
    </script>
</body>

</html>