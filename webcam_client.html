<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>灯具检测 - 本地摄像头客户端</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 1200px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .video-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }

        video,
        canvas {
            width: 100%;
            display: block;
        }

        .video-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 15px;
            border-radius: 5px;
            font-weight: bold;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label {
            font-weight: 600;
            color: #333;
        }

        input[type="text"],
        input[type="range"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        input[type="range"] {
            width: 200px;
        }

        button {
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .status {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .video-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>🔦 灯具3D定位检测系统</h1>
        <p class="subtitle">本地摄像头实时检测客户端</p>

        <div id="status" class="status disconnected">
            ⚠️ 未连接服务器
        </div>

        <div class="controls">
            <div class="control-group">
                <label>服务器地址:</label>
                <input type="text" id="serverUrl" value="http://52.18.175.128:7860" placeholder="http://服务器IP:7860">
            </div>

            <div class="control-group">
                <label>置信度:</label>
                <input type="range" id="confidence" min="0.05" max="0.5" step="0.05" value="0.15">
                <span id="confidenceValue">0.15</span>
            </div>

            <button class="btn-primary" id="startBtn">📹 启动摄像头</button>
            <button class="btn-danger" id="stopBtn" style="display:none;">⏹️ 停止</button>
        </div>

        <div class="video-grid">
            <div class="video-container">
                <video id="localVideo" autoplay playsinline></video>
                <div class="video-label">📹 本地摄像头</div>
            </div>
            <div class="video-container">
                <canvas id="resultCanvas"></canvas>
                <div class="video-label">🔍 检测结果</div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="fpsValue">0</div>
                <div class="stat-label">帧率 (FPS)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="detectionCount">0</div>
                <div class="stat-label">检测数量</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="latency">0ms</div>
                <div class="stat-label">处理延迟</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalFrames">0</div>
                <div class="stat-label">总帧数</div>
            </div>
        </div>
    </div>

    <script>
        let video, canvas, ctx;
        let isRunning = false;
        let animationId;
        let lastFrameTime = Date.now();
        let frameCount = 0;
        let totalFrames = 0;

        // 初始化
        window.onload = () => {
            video = document.getElementById('localVideo');
            canvas = document.getElementById('resultCanvas');
            ctx = canvas.getContext('2d');

            document.getElementById('startBtn').onclick = startDetection;
            document.getElementById('stopBtn').onclick = stopDetection;
            document.getElementById('confidence').oninput = (e) => {
                document.getElementById('confidenceValue').textContent = e.target.value;
            };
        };

        async function startDetection() {
            try {
                // 获取摄像头权限
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: 1280,
                        height: 720,
                        facingMode: 'user'
                    }
                });

                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                };

                isRunning = true;
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'block';
                document.getElementById('status').className = 'status connected';
                document.getElementById('status').textContent = '✅ 已连接服务器';

                // 开始检测循环
                detectLoop();

            } catch (error) {
                alert('无法访问摄像头: ' + error.message);
            }
        }

        function stopDetection() {
            isRunning = false;
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            if (animationId) {
                cancelAnimationFrame(animationId);
            }

            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('status').className = 'status disconnected';
            document.getElementById('status').textContent = '⚠️ 未连接服务器';
        }

        async function detectLoop() {
            if (!isRunning) return;

            const startTime = Date.now();

            // 将视频帧绘制到canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // 转换为Blob
            canvas.toBlob(async (blob) => {
                try {
                    // 发送到服务器进行检测
                    const serverUrl = document.getElementById('serverUrl').value;
                    const confidence = parseFloat(document.getElementById('confidence').value);

                    // 创建FormData
                    const formData = new FormData();
                    formData.append('data', JSON.stringify([null, confidence, false])); // [image, confidence, show_depth]

                    // 上传图片文件
                    const fileData = new FormData();
                    fileData.append('files', blob, 'webcam.jpg');

                    // 先上传文件
                    const uploadResponse = await fetch(`${serverUrl}/upload`, {
                        method: 'POST',
                        body: fileData
                    });

                    if (!uploadResponse.ok) {
                        throw new Error('文件上传失败');
                    }

                    const uploadResult = await uploadResponse.json();
                    console.log('Upload result:', uploadResult);

                    // 调用实时检测API (Tab 3)
                    const response = await fetch(`${serverUrl}/call/process_webcam_frame`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            data: [
                                { path: uploadResult[0] }, // 使用上传的文件路径
                                confidence,
                                false  // show_depth
                            ]
                        })
                    });

                    if (!response.ok) {
                        throw new Error('检测请求失败');
                    }

                    const result = await response.json();
                    console.log('Detection result:', result);

                    // 获取结果
                    if (result.event_id) {
                        // 等待结果
                        const eventResponse = await fetch(`${serverUrl}/call/process_webcam_frame/${result.event_id}`);
                        const eventResult = await eventResponse.json();

                        if (eventResult.output && eventResult.output.data && eventResult.output.data[0]) {
                            // 绘制检测结果图像
                            const resultImageUrl = `${serverUrl}/file=${eventResult.output.data[0].path}`;
                            const resultImage = new Image();
                            resultImage.onload = () => {
                                ctx.drawImage(resultImage, 0, 0, canvas.width, canvas.height);
                            };
                            resultImage.src = resultImageUrl;

                            // 更新检测数量 (从统计信息中提取)
                            if (eventResult.output.data[2]) {
                                const statsText = eventResult.output.data[2];
                                const match = statsText.match(/检测数量\*\*:\s*(\d+)/);
                                if (match) {
                                    document.getElementById('detectionCount').textContent = match[1];
                                }
                            }
                        }
                    }

                    // 更新统计信息
                    const latency = Date.now() - startTime;
                    document.getElementById('latency').textContent = latency + 'ms';

                    // 计算FPS
                    frameCount++;
                    totalFrames++;
                    const elapsed = Date.now() - lastFrameTime;
                    if (elapsed >= 1000) {
                        const fps = (frameCount / elapsed * 1000).toFixed(1);
                        document.getElementById('fpsValue').textContent = fps;
                        frameCount = 0;
                        lastFrameTime = Date.now();
                    }

                    document.getElementById('totalFrames').textContent = totalFrames;

                } catch (error) {
                    console.error('检测失败:', error);
                    ctx.fillStyle = 'red';
                    ctx.font = '20px Arial';
                    ctx.fillText('⚠️ 服务器连接失败: ' + error.message, 10, 30);
                    ctx.fillText('请检查服务器地址和Gradio是否运行', 10, 60);
                }

                // 继续下一帧
                if (isRunning) {
                    animationId = setTimeout(() => requestAnimationFrame(detectLoop), 100); // 限制为10fps
                }
            }, 'image/jpeg', 0.8);
        }
    </script>
</body>

</html>