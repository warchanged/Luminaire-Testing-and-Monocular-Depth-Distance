<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¯å…·æ£€æµ‹ - æœ¬åœ°æ‘„åƒå¤´å®¢æˆ·ç«¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 1200px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .video-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }

        video,
        canvas {
            width: 100%;
            display: block;
        }

        .video-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 15px;
            border-radius: 5px;
            font-weight: bold;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label {
            font-weight: 600;
            color: #333;
        }

        input[type="text"],
        input[type="range"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        input[type="range"] {
            width: 200px;
        }

        button {
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .status {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .video-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ”¦ ç¯å…·3Då®šä½æ£€æµ‹ç³»ç»Ÿ</h1>
        <p class="subtitle">æœ¬åœ°æ‘„åƒå¤´å®æ—¶æ£€æµ‹å®¢æˆ·ç«¯</p>

        <div id="status" class="status disconnected">
            âš ï¸ æœªè¿æ¥æœåŠ¡å™¨
        </div>

        <div class="controls">
            <div class="control-group">
                <label>æœåŠ¡å™¨åœ°å€:</label>
                <input type="text" id="serverUrl" value="http://52.18.175.128:7860" placeholder="http://æœåŠ¡å™¨IP:7860">
            </div>

            <div class="control-group">
                <label>ç½®ä¿¡åº¦:</label>
                <input type="range" id="confidence" min="0.05" max="0.5" step="0.05" value="0.15">
                <span id="confidenceValue">0.15</span>
            </div>

            <button class="btn-primary" id="startBtn">ğŸ“¹ å¯åŠ¨æ‘„åƒå¤´</button>
            <button class="btn-danger" id="stopBtn" style="display:none;">â¹ï¸ åœæ­¢</button>
        </div>

        <div class="video-grid">
            <div class="video-container">
                <video id="localVideo" autoplay playsinline></video>
                <div class="video-label">ğŸ“¹ æœ¬åœ°æ‘„åƒå¤´</div>
            </div>
            <div class="video-container">
                <canvas id="resultCanvas"></canvas>
                <div class="video-label">ğŸ” æ£€æµ‹ç»“æœ</div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="fpsValue">0</div>
                <div class="stat-label">å¸§ç‡ (FPS)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="detectionCount">0</div>
                <div class="stat-label">æ£€æµ‹æ•°é‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="latency">0ms</div>
                <div class="stat-label">å¤„ç†å»¶è¿Ÿ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalFrames">0</div>
                <div class="stat-label">æ€»å¸§æ•°</div>
            </div>
        </div>
    </div>

    <script>
        let video, canvas, ctx;
        let isRunning = false;
        let animationId;
        let lastFrameTime = Date.now();
        let frameCount = 0;
        let totalFrames = 0;

        // åˆå§‹åŒ–
        window.onload = () => {
            video = document.getElementById('localVideo');
            canvas = document.getElementById('resultCanvas');
            ctx = canvas.getContext('2d');

            document.getElementById('startBtn').onclick = startDetection;
            document.getElementById('stopBtn').onclick = stopDetection;
            document.getElementById('confidence').oninput = (e) => {
                document.getElementById('confidenceValue').textContent = e.target.value;
            };
        };

        async function startDetection() {
            try {
                // è·å–æ‘„åƒå¤´æƒé™
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: 1280,
                        height: 720,
                        facingMode: 'user'
                    }
                });

                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                };

                isRunning = true;
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'block';
                document.getElementById('status').className = 'status connected';
                document.getElementById('status').textContent = 'âœ… å·²è¿æ¥æœåŠ¡å™¨';

                // å¼€å§‹æ£€æµ‹å¾ªç¯
                detectLoop();

            } catch (error) {
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´: ' + error.message);
            }
        }

        function stopDetection() {
            isRunning = false;
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            if (animationId) {
                cancelAnimationFrame(animationId);
            }

            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('status').className = 'status disconnected';
            document.getElementById('status').textContent = 'âš ï¸ æœªè¿æ¥æœåŠ¡å™¨';
        }

        async function detectLoop() {
            if (!isRunning) return;

            const startTime = Date.now();

            // å°†è§†é¢‘å¸§ç»˜åˆ¶åˆ°canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // è½¬æ¢ä¸ºBlob
            canvas.toBlob(async (blob) => {
                try {
                    // å‘é€åˆ°æœåŠ¡å™¨è¿›è¡Œæ£€æµ‹
                    const serverUrl = document.getElementById('serverUrl').value;
                    const confidence = parseFloat(document.getElementById('confidence').value);

                    // åˆ›å»ºFormData
                    const formData = new FormData();
                    formData.append('data', JSON.stringify([null, confidence, false])); // [image, confidence, show_depth]

                    // ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶
                    const fileData = new FormData();
                    fileData.append('files', blob, 'webcam.jpg');

                    // å…ˆä¸Šä¼ æ–‡ä»¶
                    const uploadResponse = await fetch(`${serverUrl}/upload`, {
                        method: 'POST',
                        body: fileData
                    });

                    if (!uploadResponse.ok) {
                        throw new Error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                    }

                    const uploadResult = await uploadResponse.json();
                    console.log('Upload result:', uploadResult);

                    // è°ƒç”¨å®æ—¶æ£€æµ‹API (Tab 3)
                    const response = await fetch(`${serverUrl}/call/process_webcam_frame`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            data: [
                                { path: uploadResult[0] }, // ä½¿ç”¨ä¸Šä¼ çš„æ–‡ä»¶è·¯å¾„
                                confidence,
                                false  // show_depth
                            ]
                        })
                    });

                    if (!response.ok) {
                        throw new Error('æ£€æµ‹è¯·æ±‚å¤±è´¥');
                    }

                    const result = await response.json();
                    console.log('Detection result:', result);

                    // è·å–ç»“æœ
                    if (result.event_id) {
                        // ç­‰å¾…ç»“æœ
                        const eventResponse = await fetch(`${serverUrl}/call/process_webcam_frame/${result.event_id}`);
                        const eventResult = await eventResponse.json();

                        if (eventResult.output && eventResult.output.data && eventResult.output.data[0]) {
                            // ç»˜åˆ¶æ£€æµ‹ç»“æœå›¾åƒ
                            const resultImageUrl = `${serverUrl}/file=${eventResult.output.data[0].path}`;
                            const resultImage = new Image();
                            resultImage.onload = () => {
                                ctx.drawImage(resultImage, 0, 0, canvas.width, canvas.height);
                            };
                            resultImage.src = resultImageUrl;

                            // æ›´æ–°æ£€æµ‹æ•°é‡ (ä»ç»Ÿè®¡ä¿¡æ¯ä¸­æå–)
                            if (eventResult.output.data[2]) {
                                const statsText = eventResult.output.data[2];
                                const match = statsText.match(/æ£€æµ‹æ•°é‡\*\*:\s*(\d+)/);
                                if (match) {
                                    document.getElementById('detectionCount').textContent = match[1];
                                }
                            }
                        }
                    }

                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    const latency = Date.now() - startTime;
                    document.getElementById('latency').textContent = latency + 'ms';

                    // è®¡ç®—FPS
                    frameCount++;
                    totalFrames++;
                    const elapsed = Date.now() - lastFrameTime;
                    if (elapsed >= 1000) {
                        const fps = (frameCount / elapsed * 1000).toFixed(1);
                        document.getElementById('fpsValue').textContent = fps;
                        frameCount = 0;
                        lastFrameTime = Date.now();
                    }

                    document.getElementById('totalFrames').textContent = totalFrames;

                } catch (error) {
                    console.error('æ£€æµ‹å¤±è´¥:', error);
                    ctx.fillStyle = 'red';
                    ctx.font = '20px Arial';
                    ctx.fillText('âš ï¸ æœåŠ¡å™¨è¿æ¥å¤±è´¥: ' + error.message, 10, 30);
                    ctx.fillText('è¯·æ£€æŸ¥æœåŠ¡å™¨åœ°å€å’ŒGradioæ˜¯å¦è¿è¡Œ', 10, 60);
                }

                // ç»§ç»­ä¸‹ä¸€å¸§
                if (isRunning) {
                    animationId = setTimeout(() => requestAnimationFrame(detectLoop), 100); // é™åˆ¶ä¸º10fps
                }
            }, 'image/jpeg', 0.8);
        }
    </script>
</body>

</html>